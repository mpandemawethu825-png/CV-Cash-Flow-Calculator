<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sisonke CV - Modern Money Flow Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel operations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* Light Mode Colors */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.85);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: rgba(0, 0, 0, 0.08);
            --shadow: rgba(0, 0, 0, 0.06);
           
            /* Dark Mode Colors */
            --bg-primary-dark: #0f172a;
            --bg-secondary-dark: #1e293b;
            --bg-glass-dark: rgba(30, 41, 59, 0.85);
            --text-primary-dark: #f1f5f9;
            --text-secondary-dark: #cbd5e1;
            --text-muted-dark: #94a3b8;
            --border-color-dark: rgba(255, 255, 255, 0.08);
            --shadow-dark: rgba(0, 0, 0, 0.3);
           
            /* Accent Colors */
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --success-500: #10b981;
            --success-600: #059669;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            --purple-500: #8b5cf6;
            --purple-600: #7c3aed;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark {
            background: var(--bg-primary-dark);
            color: var(--text-primary-dark);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            z-index: -1;
            opacity: 0.5;
        }

        body.dark::before {
            opacity: 0.3;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: slideInDown 0.8s ease-out;
        }

        .header h1 {
            font-size: clamp(28px, 5vw, 42px);
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-500), var(--purple-500));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            padding: 12px 24px;
            border-radius: 50px;
            display: inline-block;
        }

        body.dark .header p {
            background: var(--bg-glass-dark);
            border-color: var(--border-color-dark);
            color: var(--text-secondary-dark);
        }

        .glass-card {
            background: var(--bg-glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 20px 40px var(--shadow);
            animation: slideInUp 0.8s ease-out;
        }

        body.dark .glass-card {
            background: var(--bg-glass-dark);
            border-color: var(--border-color-dark);
            box-shadow: 0 20px 40px var(--shadow-dark);
        }

        .input-section {
            margin-bottom: 32px;
        }

        .input-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-600);
            margin-bottom: 12px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .currency {
            position: absolute;
            left: 18px;
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-600);
            z-index: 2;
        }

        #incomeInput {
            width: 100%;
            padding: 20px 20px 20px 60px;
            font-size: 32px;
            font-weight: 600;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-primary);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark #incomeInput {
            background: var(--bg-secondary-dark);
            border-color: var(--border-color-dark);
            color: var(--text-primary-dark);
        }

        #incomeInput::placeholder {
            color: var(--text-muted);
        }

        body.dark #incomeInput::placeholder {
            color: var(--text-muted-dark);
        }

        #incomeInput:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .allocation-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 32px 0;
        }

        .allocation-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        body.dark .allocation-card {
            background: var(--bg-secondary-dark);
            border-color: var(--border-color-dark);
        }

        .allocation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--purple-500));
        }

        .allocation-card.tithes { border-color: var(--purple-500); }
        .allocation-card.savings { border-color: var(--success-500); }
        .allocation-card.cashflow { border-color: var(--primary-500); }
        .allocation-card.growth { border-color: var(--warning-500); }

        .allocation-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        body.dark .allocation-card:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .allocation-amount {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        body.dark .allocation-amount {
            color: var(--text-primary-dark);
        }

        .allocation-category {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark .allocation-category {
            color: var(--text-muted-dark);
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .update-btn, .download-btn, .preview-btn, .import-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .update-btn {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
        }

        .download-btn {
            background: linear-gradient(135deg, var(--success-500), var(--success-600));
            color: white;
        }

        .preview-btn {
            background: linear-gradient(135deg, var(--purple-500), var(--purple-600));
            color: white;
        }

        .import-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .update-btn:hover, .download-btn:hover, .preview-btn:hover, .import-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .update-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .spreadsheet-status {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px 24px;
            margin-bottom: 24px;
            text-align: center;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        body.dark .spreadsheet-status {
            background: var(--bg-glass-dark);
            border-color: var(--border-color-dark);
        }

        .status-success {
            color: var(--success-500);
            border-color: var(--success-500);
        }

        .status-error {
            color: #ef4444;
            border-color: #ef4444;
        }

        .status-info {
            color: var(--primary-500);
            border-color: var(--primary-500);
        }

        .file-upload-section {
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin: 24px 0;
            transition: all 0.3s ease;
        }

        body.dark .file-upload-section {
            background: var(--bg-secondary-dark);
            border-color: var(--border-color-dark);
        }

        .file-upload-section:hover {
            border-color: var(--primary-500);
            background: linear-gradient(135deg, var(--primary-50), var(--primary-100));
        }

        body.dark .file-upload-section:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
        }

        #excelUpload {
            display: none;
        }

        .file-upload-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .visual-flow {
            background: var(--bg-glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 32px;
        }

        body.dark .visual-flow {
            background: var(--bg-glass-dark);
            border-color: var(--border-color-dark);
        }

        .visual-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 28px;
            text-align: center;
            background: linear-gradient(135deg, var(--primary-500), var(--purple-500));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .flow-diagram {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
        }

        .flow-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            font-weight: 600;
            min-width: 220px;
            transition: all 0.3s ease;
        }

        body.dark .flow-box {
            background: var(--bg-secondary-dark);
            border-color: var(--border-color-dark);
        }

        .flow-box.main {
            font-size: 20px;
            padding: 28px;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.2);
            border: none;
        }

        .flow-box:hover {
            transform: scale(1.02);
        }

        .flow-arrow {
            text-align: center;
            color: var(--primary-500);
            font-size: 28px;
            font-weight: 300;
            margin: 12px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }

        .flow-split {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-top: 24px;
            width: 100%;
        }

        .flow-split-item {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            padding: 20px 12px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        body.dark .flow-split-item {
            background: var(--bg-secondary-dark);
            border-color: var(--border-color-dark);
        }

        .flow-split-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--purple-500));
        }

        .flow-split-item:hover {
            transform: translateY(-6px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        body.dark .flow-split-item:hover {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .flow-split-item.savings { border-color: var(--success-500); }
        .flow-split-item.cashflow { border-color: var(--primary-500); }
        .flow-split-item.remainder { border-color: var(--warning-500); }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            max-width: 1200px;
            width: 100%;
        }

        body.dark .modal-content {
            background: var(--bg-secondary-dark);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-table {
            max-height: 60vh;
            overflow: auto;
            font-size: 13px;
        }

        .modal-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .modal-table th,
        .modal-table td {
            padding: 12px;
            border: 1px solid #e2e8f0;
            text-align: left;
        }

        .modal-table th {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-table tr:nth-child(even) {
            background: #f8fafc;
        }

        body.dark .modal-table tr:nth-child(even) {
            background: #1e293b;
        }

        .modal-table tr:hover {
            background: #eff6ff;
        }

        body.dark .modal-table tr:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .footer {
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
            margin-top: 32px;
            padding: 24px;
            background: var(--bg-glass);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
        }

        body.dark .footer {
            color: var(--text-muted-dark);
            background: var(--bg-glass-dark);
            border-color: var(--border-color-dark);
        }

        .footer strong {
            color: var(--primary-600);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            font-size: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        body.dark .theme-toggle {
            background: var(--bg-secondary-dark);
            border-color: var(--border-color-dark);
        }

        .theme-toggle:hover {
            transform: scale(1.05) rotate(180deg);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Animations */
        @keyframes slideInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 15px; }
            .glass-card { padding: 24px; }
            .allocation-section { grid-template-columns: 1fr; }
            .btn-group { grid-template-columns: 1fr; }
            .flow-split { grid-template-columns: 1fr; }
            .modal-footer { flex-direction: column; }
        }

        @media (max-width: 480px) {
            .theme-toggle { top: 15px; right: 15px; width: 48px; height: 48px; font-size: 18px; }
            .header h1 { font-size: 28px; }
            .allocation-amount { font-size: 24px; }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">üåô</button>
   
    <div class="container">
        <div class="header">
            <h1>Sisonke CV</h1>
            <p>Modern Money Flow Calculator with Excel Integration</p>
        </div>

        <!-- Spreadsheet Status -->
        <div id="spreadsheetStatus" class="spreadsheet-status status-info">
            üöÄ Loading your financial system...
        </div>

        <!-- Main Calculator -->
        <div class="glass-card">
            <div class="input-section">
                <label class="input-label">Enter Your Monthly Income</label>
                <div class="input-wrapper">
                    <span class="currency">R</span>
                    <input type="number" id="incomeInput" value="60000" min="0" step="100" placeholder="Enter monthly income">
                </div>
            </div>

            <!-- Allocation Cards -->
            <div class="allocation-section">
                <div class="allocation-card tithes">
                    <div class="allocation-amount" id="titheDisplay">R9,600.00</div>
                    <div class="allocation-category">Tithes & Offerings (16%)</div>
                </div>
                <div class="allocation-card savings">
                    <div class="allocation-amount" id="savingsDisplay">R20,160.00</div>
                    <div class="allocation-category">Business Savings (40%)</div>
                </div>
                <div class="allocation-card cashflow">
                    <div class="allocation-amount" id="cashflowDisplay">R12,600.00</div>
                    <div class="allocation-category">Business Cash Flow (25%)</div>
                </div>
                <div class="allocation-card growth">
                    <div class="allocation-amount" id="growthDisplay">R17,640.00</div>
                    <div class="allocation-category">Business Growth (39%)</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="btn-group">
                <button id="updateSpreadsheetBtn" class="update-btn" onclick="updateSpreadsheet()">
                    üíæ Update Spreadsheet
                </button>
                <button id="downloadBtn" class="download-btn" onclick="downloadUpdatedSpreadsheet()" style="display: none;">
                    üì• Download Excel File
                </button>
                <button class="preview-btn" onclick="previewSpreadsheetInBrowser()">
                    üëÅÔ∏è Preview Spreadsheet
                </button>
            </div>
        </div>

        <!-- File Import Section -->
        <div class="glass-card">
            <div class="file-upload-section">
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary);">
                    üì§ Import Existing Excel File
                </div>
                <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">
                    Upload your existing Sisonke Excel file to merge new allocations
                </p>
                <input type="file" id="excelUpload" accept=".xlsx,.xls" />
                <label for="excelUpload" class="file-upload-label">
                    üñ•Ô∏è Choose Excel File
                </label>
                <button class="import-btn" onclick="importExcelFile()" style="margin-left: 16px;">
                    üìä Import & Merge
                </button>
            </div>
        </div>

        <!-- Visual Flow -->
        <div class="visual-flow">
            <div class="visual-title">üí∞ Visual Money Flow</div>
            <div class="flow-diagram">
                <div class="flow-box main">
                    Total Income<br>
                    <span style="font-size: 24px; font-weight: 800;">R<span id="visualIncome">60,000</span></span>
                </div>
                <div class="flow-arrow">‚Üì</div>
                <div class="flow-box">
                    16% ‚Üí Tithes & Offerings<br>
                    R<span id="visualTithe">9,600.00</span>
                </div>
                <div class="flow-arrow">‚Üì</div>
                <div class="flow-box">
                    84% ‚Üí Business Allocation<br>
                    R<span id="visualBusiness">50,400.00</span>
                </div>
                <div class="flow-arrow">‚Üì</div>
                <div class="flow-split">
                    <div class="flow-split-item savings">
                        <strong>40%</strong><br>
                        R<span id="visualSavings">20,160.00</span><br>
                        <small>Savings</small>
                    </div>
                    <div class="flow-split-item cashflow">
                        <strong>25%</strong><br>
                        R<span id="visualCashflow">12,600.00</span><br>
                        <small>Cash Flow</small>
                    </div>
                    <div class="flow-split-item remainder">
                        <strong>39%</strong><br>
                        R<span id="visualRemainder">17,640.00</span><br>
                        <small>Growth</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p><strong>Every Rand Has Purpose</strong><br>
            Build your business empire with crystal clear financial discipline<br>
            <small>Auto-synced to professional Excel spreadsheets</small></p>
        </div>
    </div>

    <script>
        // Global variables
        let currentWorkbook = null;
        let currentWorksheet = null;
        let allocations = {};

        // DOM Elements
        const incomeInput = document.getElementById('incomeInput');
        const updateBtn = document.getElementById('updateSpreadsheetBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const statusDiv = document.getElementById('spreadsheetStatus');

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-ZA', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function showStatus(message, type = "info") {
            statusDiv.innerHTML = `üìä ${message}`;
            statusDiv.className = `spreadsheet-status status-${type}`;
        }

        function calculateTotalIncome() {
            if (!currentWorksheet) return 0;
            const ws_data = XLSX.utils.sheet_to_json(currentWorksheet, { header: 1 });
            let total = 0;
            for (let i = 1; i < ws_data.length - 3; i++) {
                if (ws_data[i] && ws_data[i][3] !== undefined && ws_data[i][3] !== "") {
                    total += parseFloat(ws_data[i][3]) || 0;
                }
            }
            return total;
        }

        // Calculator Functions
        function updateCalculations() {
            const income = parseFloat(incomeInput.value) || 0;
           
            const tithe = income * 0.16;
            const businessTotal = income * 0.84;
            const savings = businessTotal * 0.40;
            const cashflow = businessTotal * 0.25;
            const growth = businessTotal * 0.39;
           
            // Update all display elements
            const elementsToUpdate = [
                { id: 'titheDisplay', value: tithe },
                { id: 'savingsDisplay', value: savings },
                { id: 'cashflowDisplay', value: cashflow },
                { id: 'growthDisplay', value: growth },
                { id: 'visualIncome', value: income },
                { id: 'visualTithe', value: tithe },
                { id: 'visualBusiness', value: businessTotal },
                { id: 'visualSavings', value: savings },
                { id: 'visualCashflow', value: cashflow },
                { id: 'visualRemainder', value: growth }
            ];

            elementsToUpdate.forEach(({ id, value }) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = formatCurrency(value);
                }
            });

            // Store allocations
            allocations = {
                income: income,
                tithe: tithe,
                savings: savings,
                cashflow: cashflow,
                growth: growth,
                businessTotal: businessTotal,
                date: new Date().toLocaleDateString('en-ZA')
            };

            // Update button state
            if (currentWorkbook && income > 0) {
                updateBtn.disabled = false;
            }
        }

        // Excel Functions
        function initializeSpreadsheet() {
            try {
                const wb = XLSX.utils.book_new();
                
                // Your existing data + structure
                const ws_data = [
                    ["Date", "Description", "Category", "Income (R)", "Expense (R)", "Balance (R)", "Notes"],
                    // Your original data
                    [45991, "Thozama's Kid English Tutoring", "Business Income: Tutoring", 275, "", 275, ""],
                    [45991, "CV", "Business Income: CV", 70, "", "", ""],
                    [45991, "CV", "Business Income: Tutoring", 65, "", "", ""],
                    [45991, "CV", "Business Income:Tutoring", 75, "", "", ""],
                    [new Date("11/08/2025"), "Umgidi Invitaion", "Business Income: Design", 200, "", "", ""],
                    // Empty rows
                    ...Array(80).fill().map(() => ["", "", "", "", "", "", ""]),
                    // Monthly Summary
                    ["", "MONTHLY SUMMARY", "", "", "", "", ""],
                    ["", "Total Income", "", 0, "", "", ""],
                    ["", "Total Expenses", "", 0, "", "", ""],
                    ["", "Closing Balance", "", 0, "", "", ""]
                ];

                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                
                // Column widths
                const colWidths = [
                    { wch: 12 }, // Date
                    { wch: 25 }, // Description
                    { wch: 22 }, // Category
                    { wch: 14 }, // Income
                    { wch: 14 }, // Expense
                    { wch: 14 }, // Balance
                    { wch: 30 }  // Notes
                ];
                ws['!cols'] = colWidths;

                XLSX.utils.book_append_sheet(wb, ws, "Income & Expense Tracker");
                currentWorkbook = wb;
                currentWorksheet = ws;

                const existingTotal = calculateTotalIncome();
                showStatus(`‚úÖ Spreadsheet initialized with ${existingTotal.toLocaleString('en-ZA')} existing income`, "success");
                downloadBtn.style.display = 'block';
                updateBtn.disabled = false;

            } catch (error) {
                console.error('Error initializing spreadsheet:', error);
                showStatus("‚ùå Error initializing spreadsheet", "error");
            }
        }

        function updateSpreadsheet() {
            if (!currentWorkbook || !allocations.income || allocations.income <= 0) {
                showStatus("‚ùå Please enter income first", "error");
                return;
            }

            updateBtn.disabled = true;
            updateBtn.innerHTML = '‚è≥ Updating Spreadsheet...';

            try {
                const ws_data = XLSX.utils.sheet_to_json(currentWorksheet, { header: 1 });
                
                // Find insertion point (after existing data, before summary)
                let insertRow = 6;
                while (insertRow < ws_data.length - 4 && ws_data[insertRow][0] !== "") {
                    insertRow++;
                }

                const today = new Date();
                
                // Add 4 allocation entries
                const allocationEntries = [
                    {
                        date: today,
                        description: "Monthly Tithes & Offerings",
                        category: "Spiritual Giving",
                        amount: allocations.tithe,
                        notes: "16% allocation from monthly income"
                    },
                    {
                        date: today,
                        description: "Business Savings Allocation",
                        category: "Business: Savings",
                        amount: allocations.savings,
                        notes: "40% of business allocation (Savings/Emergency Fund)"
                    },
                    {
                        date: today,
                        description: "Business Cash Flow Allocation",
                        category: "Business: Operations",
                        amount: allocations.cashflow,
                        notes: "25% of business allocation (Operations/Working Capital)"
                    },
                    {
                        date: today,
                        description: "Business Growth Allocation",
                        category: "Business: Growth",
                        amount: allocations.growth,
                        notes: "39% of business allocation (Marketing/Expansion)"
                    }
                ];

                // Insert entries
                allocationEntries.forEach(entry => {
                    ws_data.splice(insertRow, 0, [
                        entry.date,
                        entry.description,
                        entry.category,
                        entry.amount,
                        "",
                        "",
                        entry.notes
                    ]);
                    insertRow++;
                });

                // Update monthly summary
                const totalIncomeRow = ws_data.length - 3;
                const totalExpensesRow = ws_data.length - 2;
                const closingBalanceRow = ws_data.length - 1;

                let totalIncome = 0;
                for (let i = 1; i < ws_data.length - 3; i++) {
                    if (ws_data[i] && ws_data[i][3] !== undefined && ws_data[i][3] !== "") {
                        totalIncome += parseFloat(ws_data[i][3]) || 0;
                    }
                }

                ws_data[totalIncomeRow][3] = totalIncome;
                ws_data[totalExpensesRow][4] = 0;
                ws_data[closingBalanceRow][3] = totalIncome;

                // Update worksheet
                currentWorksheet = XLSX.utils.aoa_to_sheet(ws_data);
                currentWorksheet['!cols'] = [
                    { wch: 12 }, { wch: 25 }, { wch: 22 }, 
                    { wch: 14 }, { wch: 14 }, { wch: 14 }, { wch: 30 }
                ];

                const newTotal = calculateTotalIncome();
                showStatus(
                    `‚úÖ Spreadsheet updated! Added R${formatCurrency(allocations.income)} | Total: R${formatCurrency(newTotal)}`, 
                    "success"
                );
                downloadBtn.style.display = 'block';

            } catch (error) {
                console.error('Error updating spreadsheet:', error);
                showStatus("‚ùå Error updating spreadsheet: " + error.message, "error");
            } finally {
                updateBtn.disabled = false;
                updateBtn.innerHTML = 'üíæ Update Spreadsheet';
            }
        }

        function downloadUpdatedSpreadsheet() {
            if (!currentWorkbook) {
                showStatus("‚ùå No spreadsheet to download", "error");
                return;
            }

            const fileName = `Sisonke_Income_Expense_Tracker_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(currentWorkbook, fileName);
            showStatus(`üì• ${fileName} downloaded successfully!`, "success");
        }

        function previewSpreadsheetInBrowser() {
            if (!currentWorksheet) {
                showStatus("‚ùå No spreadsheet data to preview", "error");
                return;
            }

            const ws_data = XLSX.utils.sheet_to_json(currentWorksheet, { header: 1 });
            let tableRows = '';

            // Show recent 20 entries + summary
            const displayRows = ws_data.slice(Math.max(0, ws_data.length - 23), ws_data.length);

            displayRows.forEach((row, index) => {
                if (row[0] || row[1]) { // Skip completely empty rows
                    const formattedRow = row.map((cell, colIndex) => {
                        if (colIndex === 3 || colIndex === 4 || colIndex === 5) {
                            return cell ? `R${parseFloat(cell).toLocaleString('en-ZA', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : '';
                        }
                        return cell || '';
                    });
                    tableRows += `
                        <tr style="background: ${index % 2 === 0 ? '#f8fafc' : 'white'}">
                            ${formattedRow.map(cell => `<td style="padding: 10px 12px; border: 1px solid #e2e8f0; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${cell}</td>`).join('')}
                        </tr>
                    `;
                }
            });

            const modalHTML = `
                <div class="modal" onclick="if(event.target.classList.contains('modal')) this.remove()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>üìä Sisonke Income & Expense Tracker</h2>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">√ó</button>
                        </div>
                        <div class="modal-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Income (R)</th>
                                        <th>Expense (R)</th>
                                        <th>Balance (R)</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                        <div class="modal-footer">
                            <div style="flex: 1; text-align: left; color: var(--text-secondary);">
                                üìà Total Records: ${ws_data.length - 4} | 
                                üí∞ Total Income: <strong>R${formatCurrency(calculateTotalIncome())}</strong>
                            </div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button onclick="downloadUpdatedSpreadsheet(); this.parentElement.parentElement.parentElement.remove()" class="download-btn" style="padding: 10px 20px; font-size: 14px;">
                                    üì• Download Full Excel
                                </button>
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-size: 14px;">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function importExcelFile() {
            const fileInput = document.getElementById('excelUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus("‚ùå Please select an Excel file first", "error");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    if (workbook.SheetNames.length === 0) {
                        throw new Error("No sheets found in file");
                    }
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const firstSheet = workbook.Sheets[firstSheetName];
                    
                    // Replace current worksheet
                    currentWorksheet = firstSheet;
                    
                    // Update workbook
                    if (currentWorkbook) {
                        delete currentWorkbook.Sheets["Income & Expense Tracker"];
                    }
                    currentWorkbook.Sheets["Income & Expense Tracker"] = firstSheet;
                    
                    const importedData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    const totalIncome = calculateTotalIncome();
                    
                    showStatus(`‚úÖ Imported ${importedData.length - 4} records | Total Income: R${formatCurrency(totalIncome)}`, "success");
                    fileInput.value = ''; // Reset input
                    
                } catch (error) {
                    console.error('Error importing Excel:', error);
                    showStatus("‚ùå Error importing file: " + error.message, "error");
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Theme Functions
        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            const themeToggle = document.querySelector('.theme-toggle');
            themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // Event Listeners
        incomeInput.addEventListener('input', updateCalculations);
        incomeInput.addEventListener('keyup', updateCalculations);
        incomeInput.addEventListener('change', updateCalculations);

        // File input label click
        document.getElementById('excelUpload').addEventListener('change', function() {
            if (this.files[0]) {
                document.querySelector('.file-upload-label').textContent = `üìÅ ${this.files[0].name}`;
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load theme
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && systemDark)) {
                document.body.classList.add('dark');
                document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
            }
            
            // Initialize spreadsheet
            setTimeout(() => {
                initializeSpreadsheet();
                updateCalculations();
                showStatus("‚úÖ Ready to manage your finances! Enter income above.", "success");
            }, 500);
        });

        // System theme change listener
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('theme')) {
                    document.body.classList.toggle('dark', e.matches);
                    document.querySelector('.theme-toggle').textContent = e.matches ? '‚òÄÔ∏è' : 'üåô';
                }
            });
        }

        // Smooth scroll on input focus
        incomeInput.addEventListener('focus', () => {
            incomeInput.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        });

        // Auto-save calculations every 30 seconds if changed
        let lastIncomeValue = incomeInput.value;
        setInterval(() => {
            if (incomeInput.value !== lastIncomeValue) {
                lastIncomeValue = incomeInput.value;
                localStorage.setItem('lastIncome', incomeInput.value);
                updateCalculations();
            }
        }, 30000);

        // Restore last income on load
        const savedIncome = localStorage.getItem('lastIncome');
        if (savedIncome) {
            incomeInput.value = savedIncome;
            updateCalculations();
        }
    </script>
</body>
</html>
